<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Coffee Rush — v0</title>
  <meta name="description" content="Erste spielbare Version: One‑Finger Coffee‑Shop‑Spiel. Single‑File, offline‑fähig, keine Server‑Anbindung." />
  <style>
    :root{
      --bg:#221a16; --card:#2d221d; --ink:#f3e8dd; --muted:#cbbcae; --brand:#d6a879; --ok:#8fe388; --warn:#ffdb6e; --bad:#ff8ba7; --accent:#ffcf99;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: radial-gradient(1200px 800px at 70% -10%, #37291f, var(--bg) 60%); color: var(--ink);}
    .wrap{max-width:480px; margin:0 auto; padding:12px;}
    header{display:flex; gap:8px; align-items:center; justify-content:space-between; background:var(--card); border:1px solid #46372f; border-radius:14px; padding:10px 12px; position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); z-index:10}
    header .title{font-weight:800; letter-spacing:.2px}
    .stat{display:flex; gap:8px; align-items:center; font-variant-numeric:tabular-nums}
    .pill{background:#3b2e27; border:1px solid #4a3a31; color:var(--ink); padding:4px 8px; border-radius:999px; font-weight:700}

    .section{background:var(--card); border:1px solid #46372f; border-radius:16px; padding:10px; margin-top:10px}

    /* Kundenzeile */
    .row{display:flex; gap:10px; align-items:flex-start}
    .customer{flex:1; min-width:0; background:#2b201b; border:1px solid #44352d; border-radius:14px; padding:8px; position:relative; transition:transform .08s ease, box-shadow .12s ease; cursor:pointer}
    .customer .serve-btn{margin-top:6px; appearance:none; border:1px solid #6a594f; background:linear-gradient(#806a5c,#5b493f); color:var(--ink); padding:6px 10px; border-radius:10px; font-weight:700; font-size:14px; cursor:pointer}
    .customer .serve-btn:active{transform:translateY(1px) scale(.99)}
    .customer.angry{box-shadow:0 0 0 2px #ff8ba766 inset; transform:translateY(-1px)}
    .avatar{font-size:20px}
    .order{margin-top:6px; display:flex; gap:6px; flex-wrap:wrap}
    .order .it{font-size:18px; background:#3a2c25; border:1px solid #4a3a31; border-radius:8px; padding:2px 6px}
    .patience{height:6px; background:#3a2c25; border:1px solid #4a3a31; border-radius:999px; overflow:hidden; margin-top:6px}
    .patience>i{display:block; height:100%; background:linear-gradient(90deg, var(--ok), #bdf59f)}
    .bubble{position:absolute; right:8px; top:-8px; background:#3b2e27; border:1px solid #4a3a31; border-radius:999px; padding:2px 8px; font-size:12px; color:var(--muted)}

    /* Tresen */
    .counter{display:flex; gap:8px}
    .slot{flex:1; min-height:64px; background:#2b201b; border:1px solid #43352d; border-radius:14px; padding:8px; position:relative}
    .drink{display:flex; align-items:center; gap:6px; background:#3a2c25; border:2px solid #695141; border-radius:12px; padding:8px; cursor:pointer; user-select:none}
    .drink.ready{border-color:#6bbf59; box-shadow:0 0 0 2px #6bbf5966 inset}
    .drink.toxic{border-color:#18b56b; box-shadow:0 0 0 2px #18b56b66 inset; background:#20422f}
    .drink.brewing{opacity:.9}
    .cup{font-size:22px}
    .recipe{display:flex; gap:4px; flex-wrap:wrap}
    .timer{position:absolute; right:10px; top:10px; font-size:12px; background:#3b2e27; border:1px solid #4a3a31; border-radius:999px; padding:2px 6px; color:var(--muted)}

    /* Auswahl & Buttons */
    .selection{display:flex; gap:6px; flex-wrap:wrap; min-height:34px}
    .chip{font-size:18px; background:#3a2c25; border:1px solid #4a3a31; border-radius:10px; padding:4px 8px}
    .btns{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:10px}
    .btn{appearance:none; border:1px solid #5a463b; background:linear-gradient(#4b3a31,#3c2f28); color:var(--ink); padding:14px 12px; border-radius:14px; font-weight:800; font-size:18px; text-align:center; cursor:pointer; user-select:none}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.primary{border-color:#8a6a54; background:linear-gradient(#a07756,#7e5c45);}
    .btn.warn{border-color:#9b7b35; background:linear-gradient(#c39c4a,#9a7a3a);}
    .btn.danger{border-color:#8a3b4b; background:linear-gradient(#a05463,#7a3b46);}    

    footer{margin:14px 0; text-align:center; color:var(--muted); font-size:12px}
    .hint{font-size:12px; color:var(--muted);}
    .sel{outline:2px solid var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">☕ Coffee Rush <span class="hint">v0</span></div>
      <div class="stat">
        <span class="pill">Score: <b id="score">0</b></span>
        <span class="pill">Fehler: <b id="mistakes">0</b></span>
      </div>
    </header>

    <!-- Kundenzeile -->
    <section class="section">
      <div class="row" id="customers"></div>
    </section>

    <!-- Tresen -->
    <section class="section">
      <div class="counter" id="counter"></div>
      <div class="hint" style="margin-top:6px">Tippe ein fertiges Getränk, dann den passenden Kunden.</div>
    </section>

    <!-- Auswahl & Buttons -->
    <section class="section">
      <div class="hint">Zutaten auswählen (Reihenfolge zählt):</div>
      <div class="selection" id="selection"></div>
      <div class="btns" id="ingredients"></div>
      <div class="row" style="margin-top:10px; gap:8px">
        <button id="btnUndo" class="btn danger" style="flex:1">↩︎ Rückgängig</button>
        <button id="btnClear" class="btn" style="flex:1">✕ Löschen</button>
        <button id="btnBrew" class="btn primary" style="flex:2">☕ ZUBEREITEN</button>
      </div>
      <div class="hint" style="margin-top:6px">Nicht jedes Rezept hat gleich viele Schritte. Falsche Kombinationen werden abgelehnt.</div>
    </section>

    <footer>Single‑File • Läuft komplett lokal • Touch‑optimiert</footer>
  </div>

<script>
(() => {
  // ===== Config =====
  const MAX_CUSTOMERS = 3;
  const MAX_COUNTER_SLOTS = 3;
  const BASE_PATIENCE = 18_000; // ms

  // 6 Zutaten-Buttons (Emoji + Key)
  const INGREDIENTS = [
    { key:'ESP', label:'☕', name:'Espresso' },
    { key:'MIL', label:'🥛', name:'Milch' },
    { key:'CHO', label:'🍫', name:'Schoko' },
    { key:'ICE', label:'🧊', name:'Eis' },
    { key:'CRM', label:'🍦', name:'Schaum' },
    { key:'SUG', label:'🧂', name:'Zucker' },
  ];

  // Rezepte: Sequenz + Brew-Time (Sekunden)
  const RECIPES = [
    { id:'espresso', name:'Espresso', seq:['ESP'], time:2 },
    { id:'cappuccino', name:'Cappuccino', seq:['ESP','MIL','CRM'], time:4 },
    { id:'latte', name:'Latte Macchiato', seq:['MIL','ESP','CRM'], time:4 },
    { id:'mocha', name:'Mocha', seq:['ESP','CHO','MIL'], time:5 },
    { id:'iced', name:'Iced Coffee', seq:['ESP','ICE','SUG'], time:5 },
    { id:'choco', name:'Hot Chocolate', seq:['CHO','MIL','CRM'], time:4 },
  ];
  const TOXIC = { id:'toxic', name:'Giftgetränk', emoji:'☠️', time:3 };

  // ===== State =====
  const state = {
    score: 0,
    mistakes: 0,
    selection: [],           // aktuelle Zutatenwahl (Keys)
    customers: [],           // wartende Kunden
    counter: [],             // Getränke auf dem Tresen {id, name, seq, readyAt, status}
    heldDrinkId: null,       // ausgewähltes fertiges Getränk zum Servieren
    lastTick: performance.now(),
  };

  // ===== Utilities =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const el = (tag, cls, txt) => { const e = document.createElement(tag); if (cls) e.className=cls; if (txt!=null) e.textContent=txt; return e; };
  const uid = () => {
    let id = '';
    while (!id) id = Math.random().toString(36).slice(2,9);
    return id;
  };
  const bySeq = seq => RECIPES.find(r => r.seq.join('-') === seq.join('-'));

  // Patience helper
  function makeCustomer() {
    const faces = ['👩\u200d🦱','🧑\u200d🦰','🧔','👩\u200d🦳','🧑\u200d🦱','👩','🧑'];
    const order = RECIPES[Math.floor(Math.random()*RECIPES.length)];
    const patience = BASE_PATIENCE * (0.85 + Math.random()*0.5);
    return { id: uid(), face: faces[Math.floor(Math.random()*faces.length)], orderId: order.id, orderSeq: order.seq.slice(), patience, start: performance.now() };
  }

  function spawnCustomers() {
    let added = false;
    while (state.customers.length < MAX_CUSTOMERS) {
      state.customers.push(makeCustomer());
      added = true;
    }
    return added;
  }

  function freeCounterSlot() {
    return state.counter.length < MAX_COUNTER_SLOTS;
  }

  // ===== Rendering =====
  function render() {
    $('#score').textContent = state.score;
    $('#mistakes').textContent = state.mistakes;

    // Selection chips
    const sel = $('#selection'); sel.innerHTML = '';
    state.selection.forEach(k => {
      const ing = INGREDIENTS.find(i=>i.key===k); sel.append(el('span','chip', ing ? ing.label : k));
    });

    // Customers
    const cwrap = $('#customers'); cwrap.innerHTML = '';
    state.customers.forEach(c => {
      const r = RECIPES.find(r=>r.id===c.orderId);
      const box = el('div','customer'); box.tabIndex = 0;
      box.setAttribute('role','button');
      const av = el('div','avatar', c.face); box.append(av);
      const bub = el('div','bubble', r ? r.name : 'Bestellung'); box.append(bub);
      const order = el('div','order');
      c.orderSeq.forEach(k=>{
        const ing = INGREDIENTS.find(i=>i.key===k); order.append(el('span','it', ing.label));
      });
      box.append(order);
      const patience = el('div','patience'); const fill = el('i'); patience.append(fill); box.append(patience);
      // Patience percent
      const elapsed = performance.now() - c.start; const pct = Math.max(0, 1 - elapsed / c.patience);
      fill.style.width = (pct*100).toFixed(1)+'%';
      fill.style.background = pct>0.5? 'linear-gradient(90deg, var(--ok), #bdf59f)': pct>0.25? 'linear-gradient(90deg, var(--warn), #ffe8a8)': 'linear-gradient(90deg, var(--bad), #ffb3c3)';
      if (c.angryUntil && performance.now() < c.angryUntil) box.classList.add('angry');
      if (state.heldDrinkId) {
        const btn = el('button','serve-btn','Jetzt servieren');
        btn.dataset.id = c.id;
        box.append(btn);
      }
      box.dataset.id = c.id;
      cwrap.append(box);
    });

    // Counter drinks
    const dwrap = $('#counter'); dwrap.innerHTML = '';
    state.counter.forEach(d => {
      const slot = el('div','slot');
      const drink = el('div','drink '+d.status + (d.toxic?' toxic':''));
      if (state.heldDrinkId === d.id) drink.classList.add('sel');
      drink.dataset.id = d.id;
      const cup = el('div','cup', d.toxic ? '🧪' : '🧋');
      const name = el('div','', d.name);
      const rec = el('div','recipe'); d.seq.forEach(k=>{ const ing = INGREDIENTS.find(i=>i.key===k); rec.append(el('span','chip',ing.label)); });
      const left = d.status==='brewing'? Math.max(0, Math.ceil((d.readyAt - performance.now())/1000)) : 0;
      const timer = el('div','timer', d.status==='brewing'? (left+'s') : 'Bereit');
      drink.append(cup); drink.append(name); drink.append(rec); slot.append(drink); slot.append(timer);
      dwrap.append(slot);
    });
  }

  function updateLiveElements() {
    const nowT = performance.now();
    $$('.customer').forEach((box) => {
      const cid = box.dataset.id;
      const cust = state.customers.find((c) => c.id === cid);
      if (!cust) return;
      const fill = box.querySelector('.patience i');
      if (fill) {
        const pct = Math.max(0, 1 - (nowT - cust.start) / cust.patience);
        fill.style.width = (pct * 100).toFixed(1) + '%';
        fill.style.background = pct>0.5? 'linear-gradient(90deg, var(--ok), #bdf59f)': pct>0.25? 'linear-gradient(90deg, var(--warn), #ffe8a8)': 'linear-gradient(90deg, var(--bad), #ffb3c3)';
      }
      if (cust.angryUntil && nowT < cust.angryUntil) box.classList.add('angry');
      else box.classList.remove('angry');
    });
    $$('.slot').forEach((slot) => {
      const drinkEl = slot.querySelector('.drink');
      const timer = slot.querySelector('.timer');
      if (!drinkEl || !timer) return;
      const did = drinkEl.dataset.id;
      const drink = state.counter.find((d) => d.id === did);
      if (!drink) return;
      if (drink.status === 'brewing') {
        const left = Math.max(0, Math.ceil((drink.readyAt - nowT)/1000));
        timer.textContent = left + 's';
      } else {
        timer.textContent = 'Bereit';
      }
    });
  }

  // ===== Toast & Interaction Helpers =====
  const toastEl = (() => {
    const toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.position = 'fixed';
    toast.style.left = '50%';
    toast.style.bottom = '16px';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#3b2e27';
    toast.style.border = '1px solid #4a3a31';
    toast.style.padding = '8px 12px';
    toast.style.borderRadius = '10px';
    toast.style.color = 'var(--ink)';
    toast.style.fontSize = '13px';
    toast.style.opacity = '0';
    toast.style.transition = 'opacity .15s ease';
    toast.style.pointerEvents = 'none';
    toast.style.zIndex = '999';
    document.body.appendChild(toast);
    return toast;
  })();

  let toastTimer = null;
  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.style.opacity = '1';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => (toastEl.style.opacity = '0'), 1400);
  }

  const handleCounterTap = (e) => {
    const slot = e.target.closest('.slot');
    const drinkEl = e.target.closest('.drink') || (slot && slot.querySelector('.drink'));
    if (!drinkEl) return;
    const id = drinkEl.dataset.id;
    if (!id) return;
    const drink = state.counter.find((x) => x.id === id);
    if (!drink) return;
    if (drink.status !== 'ready') {
      showToast('Noch am Brühen …');
      return;
    }
    state.heldDrinkId = state.heldDrinkId === id ? null : id;
    render();
  };

  const handleCustomerTap = (e) => {
    const btn = e.target.closest('.serve-btn');
    const cEl = btn ? null : e.target.closest('.customer');
    if (!btn && !cEl) return;
    if (!state.heldDrinkId) {
      showToast('Wähle zuerst ein Getränk am Tresen');
      return;
    }
    const cid = btn ? btn.dataset.id : cEl.dataset.id;
    const cust = state.customers.find((c) => c.id === cid);
    const drink = state.counter.find((d) => d.id === state.heldDrinkId);
    if (!cust || !drink) return;
    const want = RECIPES.find((r) => r.id === cust.orderId);
    const ok = want && !drink.toxic && want.seq.join('-') === drink.seq.join('-');
    if (ok) {
      state.score += 10;
      const elapsed = performance.now() - cust.start;
      const pct = Math.max(0, 1 - elapsed / cust.patience);
      state.score += Math.round(10 * pct);
      state.customers = state.customers.filter((c) => c.id !== cid);
      state.counter = state.counter.filter((d) => d.id !== drink.id);
      state.heldDrinkId = null;
      spawnCustomers();
    } else {
      const nowT = performance.now();
      cust.angryUntil = nowT + 3000;
      const elapsed = nowT - cust.start;
      const remain = Math.max(0, cust.patience - elapsed);
      const newRemain = remain * 0.4;
      cust.start = nowT - (cust.patience - newRemain);
      state.mistakes += 1;
      state.counter = state.counter.filter((d) => d.id !== drink.id);
      state.heldDrinkId = null;
      showToast('Falsches Getränk!');
    }
    render();
  };

  function setupInteractions() {
    const counterEl = $('#counter');
    const customersEl = $('#customers');
    counterEl.addEventListener('click', handleCounterTap);
    customersEl.addEventListener('click', handleCustomerTap);
  }

  // ===== Input Wiring =====
  function setupIngredients() {
    const grid = $('#ingredients');
    INGREDIENTS.forEach(ing => {
      const b = el('button','btn');
      b.textContent = ing.label + ' ';
      const small = el('small'); small.textContent = ing.name; small.style.display='block'; small.style.fontSize='12px'; small.style.opacity='0.8';
      b.append(small);
      b.addEventListener('click', () => { state.selection.push(ing.key); render(); });
      grid.append(b);
    });
  }

  $('#btnUndo').addEventListener('click', () => { state.selection.pop(); render(); });
  $('#btnClear').addEventListener('click', () => { state.selection = []; render(); });

  // Prepare/Brew
  $('#btnBrew').addEventListener('click', () => {
    if (!freeCounterSlot()) { bumpMistake('Tresen voll'); return; }
    if (state.selection.length === 0) { bumpMistake('Kein Rezept'); return; }
    const recipe = bySeq(state.selection);
    const id = uid();
    const nowT = performance.now();
    if (!recipe) {
      // Unbekannte Kombi wird zum Giftgetränk
      state.counter.push({ id, name: TOXIC.name, seq: state.selection.slice(), status:'brewing', readyAt: nowT + TOXIC.time*1000, toxic:true });
    } else {
      state.counter.push({ id, name: recipe.name, seq: recipe.seq.slice(), status:'brewing', readyAt: nowT + recipe.time*1000, toxic:false });
    }
    state.selection = []; render();
  });

  // Select drink then tap customer to serve
  function bumpMistake(_msg) {
    state.mistakes += 1;
    if (_msg) showToast(_msg);
  }

  // ===== Game Loop (timers, patience, brewing) =====
  function tick() {
    const t = performance.now();
    let needsRender = false;
    state.counter.forEach((d) => {
      if (d.status === 'brewing' && t >= d.readyAt) {
        d.status = 'ready';
        needsRender = true;
      }
    });
    for (let i = state.customers.length - 1; i >= 0; i--) {
      const c = state.customers[i];
      if (t - c.start > c.patience) {
        state.customers.splice(i, 1);
        state.mistakes += 1;
        needsRender = true;
      }
    }
    if (spawnCustomers()) needsRender = true;
    if (needsRender) render();
    updateLiveElements();
    requestAnimationFrame(tick);
  }

  // ===== Init =====
  setupIngredients();
  spawnCustomers();
  setupInteractions();
  render();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
